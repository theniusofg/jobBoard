name: Fetch Google Sheets Data

on:
  workflow_dispatch:  # Manual trigger
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight

jobs:
  fetch-sheets-data:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'
    
    - name: Install Dependencies
      run: |
        npm init -y
        npm install googleapis
    
    - name: Create fetch script
      env:
        GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
      run: |
        cat > fetch.js << 'EOF'
        const { google } = require('googleapis');
        const fs = require('fs');

        async function fetchSheetsData() {
          try {
            // Check if environment variable exists
            if (!process.env.GOOGLE_SERVICE_ACCOUNT_KEY) {
              throw new Error('GOOGLE_SERVICE_ACCOUNT_KEY environment variable is not set');
            }

            console.log('Service account key length:', process.env.GOOGLE_SERVICE_ACCOUNT_KEY.length);
            
            const auth = new google.auth.GoogleAuth({
              credentials: JSON.parse(process.env.GOOGLE_SERVICE_ACCOUNT_KEY),
              scopes: ['https://www.googleapis.com/auth/spreadsheets.readonly']
            });

            const sheets = google.sheets({ version: 'v4', auth });
            
            const SPREADSHEET_ID = '1pYihXbRT8heKDOqbl8MxGZxlzeA6ka_TyeazM-0Tts4';
            
            const response = await sheets.spreadsheets.values.get({
              spreadsheetId: SPREADSHEET_ID,
              range: 'Sheet1'
            });

            fs.writeFileSync('sheets_data.json', JSON.stringify(response.data.values, null, 2));
            console.log('Data saved to sheets_data.json');
            console.log('Rows fetched:', response.data.values ? response.data.values.length : 0);
          } catch (error) {
            console.error('Error fetching data:', error.message);
            process.exit(1);
          }
        }

        fetchSheetsData();
        EOF
        
        echo "Script created, checking environment..."
        if [ -z "$GOOGLE_SERVICE_ACCOUNT_KEY" ]; then
          echo "ERROR: GOOGLE_SERVICE_ACCOUNT_KEY is not available in this step"
          exit 1
        else
          echo "Environment variable is available (length: ${#GOOGLE_SERVICE_ACCOUNT_KEY})"
        fi
    
    - name: Fetch Google Sheets Data
      env:
        GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
      run: node fetch.js
    
    - name: Verify file exists
      run: |
        if [ -f sheets_data.json ]; then
          echo "File created successfully"
          cat sheets_data.json
        else
          echo "File was not created"
          exit 1
        fi
    
    - name: Commit and Push Data
      run: |
        git config user.name github-actions
        git config user.email github-actions@github.com
        git add sheets_data.json
        git diff --staged --quiet || git commit -m "Update sheets data"
        git push